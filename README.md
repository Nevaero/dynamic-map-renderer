# Dynamic Map Renderer

## Description

The Dynamic Map Renderer is a web-based application designed for tabletop roleplaying games (TTRPGs). It transforms static map images into dynamic displays, allowing a Game Master (GM) to control the map appearance, apply visual effects (filters), and manage the view presented to players in real-time. This initial release focuses on image-based maps with a retro sci-fi aesthetic - good for Mothership, Traveller, or the Aliens RPG.

![Animation of map](./MapRendererDemo.gif)

## Quick Notes

This is the second release and includes the masking/fog of war functionality. I am looking for feedback and suggestions. Much of this was inspired by the amazing work by the Quadra team who created the Tannhauser Remote Desktop for their Warped Beyond Recognition adventure. I just wanted to make a GM-driven client-server tool that would work to spruce up an otherwise bland map.

I grabbed a couple of example maps to show it working. Both seemed pretty widely distributed across various websites - so I don't anticipate anyone will mind. That said, I did not seek permission in advance - so I am happy to remove them if requested!
* USS Pharoah: https://www.failuretolerated.com/mothership-ship-creation-sheet
* The Alexis: from Dead Planet: https://www.drivethrurpg.com/en/product/484228/mothership-dead-planet

This project has been "Vibe coded" - a dirty word for many. This means that while I directed the process, the code itself was primarily generated by Google's Gemini 2.5 Pro (experimental). I claim no ownership over the program or code here and anyone can use it for any purpose without permission. If you use it, letting me know what for would be cool (just for personal interest).

## Current Features (v0.4.1)

* **Image Map Support:** Load and display `.png`, `.jpg`, `.jpeg`, and `.webp` map files.
* **GM Control Interface:** Web interface for the GM to manage the session, with a collapsible and resizable left panel. [panel updated in v0.3.1]
* **Player View:** Separate web view for players, displaying the GM-controlled map with touch support (pinch-to-zoom). [pinch-to-zoom new in v0.3]
* **Visual Filters:** Apply pre-defined visual filters to the map image:
    * Retro Sci-Fi Green [updated in v0.2]
    * Retro Sci-Fi Amber [updated in v0.2]
    * None (does allow inverting image)
* **Player View Control:** GM can pan (Center X/Y) and zoom (Scale) the view shown to players.
* **Auto Saving/Loading:** Map configurations are auto-saved with each change (selected filter, parameters, view state) per map image. Configs are stored as JSON files in the `./configs/` directory. [new in v0.2]
* **Save/Load System:** SQLite-backed save system (`saves.db`) with full CRUD — create, rename, overwrite, and delete named saves from the GM panel. The most recent save is auto-loaded on server startup. [new in v0.3.1]
* **Masking/Fog Of War:** GM can hide areas of the map from the players and quickly show them if needed. [new in v0.2]
* **Shape Tools:** Draw fog polygons using predefined shapes (circle, ellipse, square, rectangle, triangle) via click-and-drag, in addition to freehand drawing. [new in v0.3]
* **Polygon Editing:** Select a fog polygon to move it by dragging, edit individual vertices, or recolor it via color swatches in the context popup and sidebar. [new in v0.3]
* **Circle/Ellipse Resize Handles:** Circles and ellipses show 4 corner resize handles instead of individual vertices, allowing intuitive resizing while maintaining shape. [new in v0.3]
* **Rectangle/Square Resize Handles:** Figma-style edge midpoint handles for side-dragging and corner handles for proportional resize on squares and rectangles. [new in v0.3]
* **Fog Undo/Redo:** Ctrl+Z to undo and Ctrl+Y (or Ctrl+Shift+Z) to redo any fog operation — drawing, deleting, moving, vertex editing, resizing, and color changes. Supports up to 50 undo states. [new in v0.3]
* **Player Tokens:** Draggable, labeled, colored tokens that both GM and players can place and move. Tokens persist in server memory across page reloads. Shared logic via `token-shared.js`. [new in v0.3]
* **QR Code Sharing:** Generate a QR code for the player URL for easy mobile/tablet access. [new in v0.3]
* **Cloudflare Tunnel:** Optional remote access — if `cloudflared.exe` is found, a tunnel is started automatically in the background, providing a public URL for remote players. [new in v0.3.1]
* **GM Authentication:** The GM view is gated behind a one-time secret token generated at startup. Players who try to access `/` are shown a themed "Access Denied" page and redirected to the player view. [new in v0.4]
* **Single GM Enforcement:** Only one GM socket connection is allowed at a time — duplicate connections are rejected to prevent conflicts. [new in v0.4]
* **Protected APIs & Events:** All write endpoints (map upload, config save, save CRUD) and the `gm_update` socket event require a valid GM session. Players receive a 403 error on unauthorized calls. [new in v0.4]
* **Player Preview:** Live player-view iframe embedded in the bottom-right of the GM interface — toggle with the `P` key or the Preview button, resizable via top-left drag handle. Tokens are hidden in preview to avoid duplication with the GM overlay. [new in v0.4.1]
* **Standalone Build:** Builds to a single `.exe` via PyInstaller (`build.bat` / `DynamicMapRenderer.spec`) for easy distribution. [new in v0.3]
* **Help:** Some help to get started shown as the default map on load. [new in v0.2]
* **Real-time Updates:** Player views update instantly via WebSockets (Socket.IO) when the GM makes changes.

## Setup Instructions

You will need a working Python 3.xx environment to use this. Further dependencies installed in step 3.
You can skip Step 1 and 2 if you just want to download the "Code -> Download ZIP file". 

1.  **Clone the Repository:**
    ```bash
    git clone https://github.com/FrunkQ/dynamic-map-renderer.git
    cd dynamic-map-renderer
    ```
2.  **Create & Activate Virtual Environment (Optional but Recommended):**
    While it might work from your existing Python environment, using a virtual environment is recommended to manage dependencies.
    ```bash
    # For Linux/macOS
    python3 -m venv venv
    source venv/bin/activate
     ```
    ```bash
    # For Windows
    python -m venv venv
    .\venv\Scripts\activate
    ```
3.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```
    *(Requires Python 3.x)*
4.  **Run the Application:**
    ```bash
    python app.py
    ```
    The server will start and print a GM URL with a secret token in the console (e.g. `http://127.0.0.1:5000/?token=abc123...`). Your browser will auto-open to this URL.

## Usage

1.  **GM View:** The browser auto-opens the GM URL with the secret token on startup. The token is shown in the server console — bookmark it or copy it if you need to reopen the tab. Navigating to `http://127.0.0.1:5000/` without the token will show an "Access Denied" page and redirect to the player view.
    * Upload map images using the "Upload New Map Image" section.
    * Select a map from the "Select Map" dropdown.
    * Choose a filter from the "Select Filter" dropdown.
    * Adjust filter parameters using the sliders/controls that appear.
    * Adjust the Player View using the "Center X/Y" and "Scale" sliders.
	* Mask parts of the map by drawing polygons (freehand or shape tools) on the map.
	* Select polygons to move, resize (edge/corner handles), edit vertices, or recolor them via swatches.
	* Undo/redo fog changes with Ctrl+Z / Ctrl+Y.
    * Place tokens on the map — set label (up to 2 chars) and color, then click to place.
    * Save and load game state using the saves panel — create named saves, rename, overwrite, or delete them. The latest save is auto-loaded when the server starts.
    * Preview what players see in real-time — press `P` or click the Preview button in the bottom-right corner. Drag the top-left handle to resize.
    * The left panel is collapsible (click the toggle) and resizable (drag the edge).
    * Only one GM connection is allowed at a time. If a second tab tries to connect as GM, the new connection is rejected.

2.  **Player View:** Share the player URL displayed in the GM controls panel with your players: `http://<your-ip>:5000/player`. Players cannot access the GM interface — attempting to visit `/` without the token shows a retro-themed "Access Denied" screen. Players can view the map, interact with tokens (place, move, recolor), and use pinch-to-zoom on touch devices — but cannot modify filters, fog, saves, or other GM-only state.

3.  **Remote Access (Cloudflare Tunnel):** If `cloudflared.exe` is available on the system PATH (or next to the executable), a tunnel is started automatically in the background. The public URL is displayed in the GM panel and can be shared with remote players — no port forwarding required.

## Directory Structure

* `app.py`: Slim entry point — creates app, runs server, auto-opens GM URL.
* `server/`: Backend package (modular refactor from single `app.py`).
  * `__init__.py`: `create_app()` factory, registers blueprints + sockets.
  * `auth.py`: `@gm_required` decorator for protecting write endpoints.
  * `config.py`: Paths, constants, folder creation, logging, LAN IP, `GM_SECRET` token.
  * `state.py`: Shared mutable globals (`current_state`, `current_tokens`, `current_save_id`, `gm_socket_sid`).
  * `filters.py`: Filter loading from GLSL shader directories.
  * `helpers.py`: Map config I/O, state builders, `merge_dicts`.
  * `map_gen.py`: Fog-of-war compositing (`generate_player_map`, `generate_player_map_bytes`).
  * `tunnel.py`: Cloudflare tunnel management (auto-detect + background start).
  * `routes_core.py`: Blueprint — GM-gated `/` route, file serving, filter/map/config APIs.
  * `routes_saves.py`: Blueprint — SQLite save/load CRUD + auto-load on startup.
  * `sockets.py`: All SocketIO event handlers (GM socket tracking, token events).
* `requirements.txt`: Python dependencies.
* `templates/`: HTML files for GM (`index.html`), Player (`player.html`), and Access Denied (`unauthorized.html`) views.
* `static/`: CSS (`style.css`) and JavaScript (`gm.js`, `player.js`, `token-shared.js`) files.
* `maps/`: Directory to store map image files.
* `configs/`: Directory to store saved per-map JSON configuration files.
* `generated_maps/`: Temporary fog-composited map images.
* `saves.db`: SQLite database for named saves.
* `filters/`: Contains subdirectories for each filter, holding `config.json` and vertex/fragment `.glsl` shaders.
* `build.bat` / `DynamicMapRenderer.spec`: PyInstaller build config for standalone `.exe`.

## Known Issues / Limitations (v0.4.1)

* **Hardcoded Session ID:** Player sessions currently *must* use the hardcoded session ID `my-game`. Custom session IDs are not yet supported.
* **Token regenerates on restart:** The GM secret token changes every time the server restarts. You'll need to use the new URL printed in the console each time.

## Future Plans

The following features are planned for future releases:

1.  **Sound Features:** Integrate sound effects or ambient audio tied to the map or markers (e.g., an Aliens-style motion tracker where sound varies depending upon player location).
2.  **Player Window Transitions:** Add visual transitions (e.g., fades) when the map or filter changes in the player view.
3.  **User-Defined Session IDs:** Allow the GM to create custom, memorable session IDs.

---
